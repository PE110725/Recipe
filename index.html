<!DOCTYPE html>
<html>
<head>
  <title>Product Entry Form</title>
  <style>
    body { font-family: Arial; max-width: 600px; margin: auto; }
    input, select, button { width: 100%; padding: 8px; margin: 6px 0; }
    .item-row { display: flex; gap: 10px; }
    .item-row input { flex: 1; }
  </style>
</head>
<body>
  <h2>Product Entry Form</h2>
  <form id="entryForm">
    <label for="polymer">Polymer:</label>
    <select id="polymer" name="polymer" required>
      <option value="">Select Polymer</option>
      <option>PE</option><option>PVC</option><option>EVA</option><option>ABS</option>
      <option>SAN</option><option>GPPS</option><option>NYLON</option><option>PET</option>
      <option>PC</option><option>PTFE</option><option>R-PE</option><option>R-LD</option>
      <option>R-LLD</option><option>R-PPCP</option><option>R-PVC</option><option>R-EVA</option>
      <option>R-ABS</option><option>R-SAN</option><option>R-GGPS</option><option>R-PET</option>
      <option>R-NYLON</option>
    </select>

    <label for="product">Product Name:</label>
    <input type="text" id="product" name="product" required>

    <label for="color">Color:</label>
    <input type="text" id="color" name="color" required>

    <div id="itemsContainer">
      <div class="item-row">
        <input type="text" name="item" placeholder="Item Name" required>
        <input type="number" name="weight" placeholder="Weight (g)" step="0.001" required>
      </div>
    </div>

    <button type="button" onclick="addItem()">Add More Item</button>

    <label for="pantone">Pantone Code:</label>
    <input type="text" id="pantone" name="pantone">

    <label for="ral">RAL Code:</label>
    <input type="text" id="ral" name="ral">

    <label for="application">Application:</label>
    <input type="text" id="application" name="application">

    <label for="additional">Additional Notes:</label>
    <input type="text" id="additional" name="additional">

    <button type="submit">Submit</button>
  </form>

  <script>
    function addItem() {
      const container = document.getElementById("itemsContainer");
      const row = document.createElement("div");
      row.className = "item-row";
      row.innerHTML = `
        <input type="text" name="item" placeholder="Item Name" required>
        <input type="number" name="weight" placeholder="Weight (g)" step="0.001" required>
      `;
      container.appendChild(row);
    }

    function toUpperCaseFields(form) {
      const fields = form.querySelectorAll("input[type='text'], input[type='number'], select");
      fields.forEach(field => {
        if (field.value) field.value = field.value.toString().toUpperCase();
      });
    }

    document.getElementById("entryForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const form = e.target;
      toUpperCaseFields(form);

      const polymer = form.polymer.value;
      const product = form.product.value;
      const color = form.color.value;
      const pantone = form.pantone.value;
      const ral = form.ral.value;
      const application = form.application.value;
      const additional = form.additional.value;

      const itemInputs = form.querySelectorAll("input[name='item']");
      const weightInputs = form.querySelectorAll("input[name='weight']");

      const items = [];
      const weights = [];
      let totalWeight = 0;

      itemInputs.forEach((itemInput, i) => {
        const item = itemInput.value;
        const weight = parseFloat(weightInputs[i].value || 0);
        if (item && !isNaN(weight)) {
          items.push(item);
          weights.push(weight);
          totalWeight += weight;
        }
      });

      const colorCodeMap = {
        "NATURAL": "00", "BLACK": "10", "WHITE": "20", "RED": "30",
        "GREEN": "40", "YELLOW": "50", "BLUE": "60", "ORANGE": "70"
      };

      const prefixMap = {
        "PE": "1605C", "PVC": "1603C", "ABS": "0119E", "SAN": "1914E", "GPPS": "0719E",
        "PET": "1620E", "EVA": "0501C", "NYLON": "1414E", "ADDITIVE": "0105AD",
        "PTFE": "1606E", "PC": "1603E"
      };

      const cleanPoly = polymer.replace("R-", "");
      const prefix = prefixMap[cleanPoly] || "XXXX";
      const isRecycled = polymer.startsWith("R-");

      const colorKey = color.toUpperCase();
      const colorCode = colorCodeMap[colorKey] || "99";

      // Call server to get serial number and generate finalCode
      const serialGenURL = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"; // Replace with your deployed Apps Script URL

      fetch(serialGenURL + `?prefix=${prefix}&color=${colorCode}&recycled=${isRecycled}`)
        .then(res => res.json())
        .then(data => {
          const serial = data.serial.padStart(3, "0");
          const finalCode = `${prefix}${isRecycled ? "R" : ""}${colorCode}${serial}`;

          const payload = {
            polymer, product, color, finalCode, items: JSON.stringify(items),
            weights: JSON.stringify(weights), totalWeight, pantone, ral, application, additional
          };

          fetch("https://script.google.com/macros/s/AKfycby0CgwuKR9e7oW8hyG26NY70oVD2mjfETvsm2_1TN7Y_zku3qOarBxZlJpFbNsGVVw/exec", {
            method: "POST",
            body: new URLSearchParams(payload)
          })
            .then(r => r.text())
            .then(alert)
            .catch(err => alert("Error: " + err));
        });
    });
  </script>
</body>
</html>
